# Архитектура проекта

## Общий обзор

### Основные компоненты
```
┌─────────────────┐     ┌──────────────┐     ┌─────────────┐
│  Telegram Bot   │────▶│  Application  │────▶│  Database   │
└─────────────────┘     └──────────────┘     └─────────────┘
         ▲                      │                    ▲
         │                      ▼                    │
         │              ┌──────────────┐            │
         └──────────────│  Scheduler   │────────────┘
                       └──────────────┘
```

### Технологический стек
- **Фреймворк**: aiogram 2.25.1
- **База данных**: PostgreSQL + Tortoise ORM
- **Планировщик**: APScheduler
- **Валидация**: Pydantic
- **Тестирование**: pytest
- **CI/CD**: GitHub Actions

## Компоненты системы

### 1. Ядро приложения (app/bot.py)
```python
class Application:
    """
    Основной класс приложения
    
    Отвечает за:
    - Инициализацию компонентов
    - Обработку команд
    - Управление состоянием
    - Обработку ошибок
    """
```

### 2. Модели данных (app/db/models.py)
```
┌──────────┐     ┌───────────┐     ┌─────────┐
│   User   │────▶│ Workplace │────▶│ Record  │
└──────────┘     └───────────┘     └─────────┘
```

### 3. Обработчики команд (app/handlers/)
```
┌─────────────┐
│  Handlers   │
├─────────────┤
│ /start      │
│ /workplaces │
│ /add_record │
│ /reports    │
│ /settings   │
└─────────────┘
```

### 4. Middleware (app/middlewares/)
```
┌───────────────┐     ┌─────────────┐
│ Request       │────▶│ Error       │
└───────────────┘     └─────────────┘
       │                     ▲
       ▼                     │
┌───────────────┐     ┌─────────────┐
│ Rate Limiter  │────▶│ Response    │
└───────────────┘     └─────────────┘
```

### 5. Планировщик задач (app/utils/scheduler.py)
```
┌─────────────────────┐
│     Scheduler       │
├─────────────────────┤
│ Daily Reminders     │
│ Weekly Reports      │
│ Monthly Cleanup     │
│ Database Backup     │
└─────────────────────┘
```

## Потоки данных

### 1. Обработка команд
```
User ──▶ Telegram ──▶ Bot ──▶ Handler ──▶ Database
  ▲                                          │
  └──────────────── Response ◀──────────────┘
```

### 2. Фоновые задачи
```
Scheduler ──▶ Task ──▶ Database ──▶ Bot ──▶ User
     ▲         │         │
     └─────────┴─────────┘
```

### 3. Валидация данных
```
Input ──▶ Validator ──▶ Model ──▶ Database
  ▲                              │
  └────────── Error ◀────────────┘
```

## Безопасность

### 1. Аутентификация
```
┌──────────┐     ┌──────────┐     ┌──────────┐
│ Telegram │────▶│   Bot    │────▶│   User   │
└──────────┘     └──────────┘     └──────────┘
                      │
                      ▼
                ┌──────────┐
                │  Admin   │
                └──────────┘
```

### 2. Защита данных
- Шифрование базы данных
- Безопасное хранение токенов
- Ограничение доступа к API

## Масштабирование

### 1. Горизонтальное масштабирование
```
┌─────────┐     ┌─────────┐
│  Bot 1  │────▶│  DB 1   │
└─────────┘     └─────────┘
     ▲               ▲
     │               │
┌─────────┐     ┌─────────┐
│  Load   │     │   DB    │
│Balancer │◀───▶│Replica  │
└─────────┘     └─────────┘
     │               │
     ▼               ▼
┌─────────┐     ┌─────────┐
│  Bot 2  │────▶│  DB 2   │
└─────────┘     └─────────┘
```

### 2. Вертикальное масштабирование
- Увеличение ресурсов сервера
- Оптимизация запросов
- Кэширование данных

## Мониторинг

### 1. Метрики
```
┌────────────┐     ┌────────────┐
│ Application│────▶│  Metrics   │
└────────────┘     └────────────┘
                        │
                        ▼
┌────────────┐     ┌────────────┐
│   Alert    │◀────│ Monitoring │
└────────────┘     └────────────┘
```

### 2. Логирование
```
┌────────────┐
│   Events   │
└────────────┘
      │
      ▼
┌────────────┐
│   Logs     │
└────────────┘
      │
      ▼
┌────────────┐
│  Analysis  │
└────────────┘
```

## Развертывание

### 1. Docker контейнеры
```
┌────────────┐     ┌────────────┐
│    Bot     │────▶│ PostgreSQL │
└────────────┘     └────────────┘
      │                  │
      ▼                  ▼
┌────────────┐     ┌────────────┐
│   Redis    │────▶│  Backups   │
└────────────┘     └────────────┘
```

### 2. CI/CD пайплайн
```
┌──────────┐     ┌──────────┐     ┌──────────┐
│   Code   │────▶│  Tests   │────▶│  Build   │
└──────────┘     └──────────┘     └──────────┘
                                        │
                                        ▼
┌──────────┐     ┌──────────┐     ┌──────────┐
│Production│◀────│  Deploy  │◀────│  Docker   │
└──────────┘     └──────────┘     └──────────┘
```

## Расширение функциональности

### 1. Новые команды
1. Создать обработчик в `app/handlers/`
2. Добавить валидацию в `app/utils/validators.py`
3. Обновить тесты
4. Обновить документацию

### 2. Новые фоновые задачи
1. Добавить задачу в `app/utils/scheduler.py`
2. Настроить расписание
3. Добавить обработку ошибок
4. Обновить мониторинг

## Зависимости

### 1. Внешние сервисы
- Telegram Bot API
- TimeZoneDB API
- PostgreSQL

### 2. Внутренние компоненты
- Tortoise ORM
- APScheduler
- Pydantic
- aiohttp 